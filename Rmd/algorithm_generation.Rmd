---
title: "Algorithm"
author: "Anandu R"
date: "5/31/2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Importing necessary packages/Libraries 

```{r}
invisible(library(dplyr))
invisible(library(lubridate))
invisible(library(caTools))
invisible(library(data.table))
invisible(library(rpart))
invisible(library(rpart.plot))
invisible(library(C50))
```


## Generating the dataset 

Data description:

- speed: Real-time speed of the bus in commute .
- dist_prev: The distance between the current bus and the previous bus on the same route.
- dist_next: The distance between the current bus and the next bus on the same route.
- crowd_curr: The number of passengers currently in the bus.
- crowd_next: The number of passengers in the next bus on the same route.
- schd_time: The scheduled arrival time specified for bus at previous stop on their route.
- arr_time: The actual arrival time of the bus at the previous stop on their route.
- on_time: Whether the bus arrived on time or not at the previous stop on their route.
- time_delay: The difference between the actual arrival time and the scheduled arrival time.


```{r}
set.seed(1)
speed = round(rnorm(1000,50,15),2)
dist_prev = abs(round(rnorm(1000,2,1),2))
dist_next = abs(round(rnorm(1000,2,1),2))
crowd_curr = rpois(1000,25)
crowd_next = rpois(1000,25)
schd_time = sample(seq(strptime('01/01/2018',format = "%d/%m/%Y"),
                       strptime('01/01/2019',format = "%d/%m/%Y"),
                       by="hour"), 1000, replace = T)
arr_time = schd_time+(rnorm(1000,300,350)*-1)
on_time = ifelse(difftime(arr_time,schd_time)<=0,1,0)
time_delay = difftime(arr_time,schd_time)
data = data.frame(crowd_curr,crowd_next,
                  dist_prev, dist_next,speed,
                  schd_time,arr_time,on_time,time_delay)
head(select(data,crowd_curr,crowd_next,on_time),10)
```


## Generating an algorithm to label the datasets 

Each record is considered as a bus and the label is the indication given to the bus driver whether to maintain speed, decrease speed, or to increase represented by 0,1,2 respectively 

```{r}
data = data %>% mutate(.,indicate = with(.,case_when(
  (dist_next<1.8 & dist_prev<1.8 & crowd_next<25 & crowd_curr<28) ~ 0,
  (dist_next<1.8 & dist_prev<1.8 & crowd_next<25 & crowd_curr>28) ~ 0,
  (dist_next<1.8 & dist_prev<1.8 & crowd_next>25 & crowd_curr<28) ~ 2,
  (dist_next<1.8 & dist_prev<1.8 & crowd_next>25 & crowd_curr>28) ~ 0,
  (dist_next<1.8 & dist_prev>1.8 & crowd_next<25 & crowd_curr<28) ~ 1,
  (dist_next<1.8 & dist_prev>1.8 & crowd_next<25 & crowd_curr>28) ~ 1,
  (dist_next<1.8 & dist_prev>1.8 & crowd_next>25 & crowd_curr<28) ~ 2,
  (dist_next<1.8 & dist_prev>1.8 & crowd_next>25 & crowd_curr>28) ~ 1,
  (dist_next>1.8 & dist_prev<1.8 & crowd_next<25 & crowd_curr<28) ~ 2,
  (dist_next>1.8 & dist_prev<1.8 & crowd_next<25 & crowd_curr>28) ~ 0,
  (dist_next>1.8 & dist_prev<1.8 & crowd_next>25 & crowd_curr<28) ~ 2,
  (dist_next>1.8 & dist_prev<1.8 & crowd_next>25 & crowd_curr>28) ~ 2,
  (dist_next>1.8 & dist_prev>1.8 & crowd_next<25 & crowd_curr<28) ~ 0,
  (dist_next>1.8 & dist_prev>1.8 & crowd_next<25 & crowd_curr>28) ~ 0,
  (dist_next>1.8 & dist_prev>1.8 & crowd_next>25 & crowd_curr<28) ~ 2,
  (dist_next>1.8 & dist_prev>1.8 & crowd_next>25 & crowd_curr>28) ~ 0,
)))

head(select(data,crowd_curr,on_time,indicate),10)
```  

&nbsp;  

&nbsp;  

&nbsp;  

The table below indicates the indications that each of the bus instances receive 

```{r}
data$indicate = factor(data$indicate,
                       levels=c(0,1,2),
                       labels = c("Maintain Speed",
                                  "Slow Down",
                                  "Speed Up"))
table(data$indicate)
```  

Thus we obtain the following observations from above table:  

- Number of buses instructed to "Maintain Speed" : 314
- Number of buses instructed to "Slow Down" : 123
- Number of buses instructed to "Speed Up" : 412  


&nbsp;  

&nbsp;  

&nbsp;  

&nbsp;  

## Modelling a decision tree algorithm to make future scheduling 

Splitting the data into train and test 

```{r}
set.seed(1)
split = sample.split(data$indicate, SplitRatio = 0.75)
train = data[split,]
test = data[!split,]
```


Creating a penalty matrix to avoid miscalculation 

```{r}
penalty.matrix <- matrix(c(1,1,0,10,0,10,0,0,0), byrow=TRUE, nrow=3)
```  

&nbsp;  

&nbsp;  

&nbsp;  

&nbsp;  

&nbsp;  

&nbsp;  

&nbsp;  

&nbsp;  

&nbsp; 

&nbsp;

Building the decision tree model with rpart 

```{r}
dtree <- rpart(indicate~.,data=data,method = "class")
```

Visualizing the decision tree 

```{r}
rpart.plot(dtree, nn=TRUE)
```  

&nbsp;  

&nbsp;  

&nbsp;  

&nbsp;  

&nbsp;  

&nbsp;  

&nbsp;  

&nbsp;  

&nbsp; 

&nbsp;


## Using speed and on_time parameters 

The speed and on_time parameters can be used for further analysis and using a regression model, we can provide the driver with recommended speed indication to maintain their schedule, and to keep them aware of whether they're on time or not 

```{r}
head(select(data,speed,on_time))
```

